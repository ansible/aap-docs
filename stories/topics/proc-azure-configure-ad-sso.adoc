[id="proc-azure-configure-ad-sso_{context}"]

= {MSEntraID} SSO configuration

[role="_abstract"]

For help with setting up and configuring your enterprise authentication, see the _Chapter 3. Configuring Microsoft Entra ID authentication_ section of the link:{URLCentralAuth}[{TitleCentralAuth}] guide. 


.Creating a registered application in {MSEntraID}

. In a web browser, open the Azure portal.
. Ensure that you are using the tenant where you deployed {PlatformNameShort}.
. Type `Microsoft Entra ID` in the search bar.
. Select *{MSEntraID}* from the search results.
. Under *Manage* in the menu options, click *App registrations*.
. In the *App registrations* page, click *+ New registration*.
. Configure the new registration as follows:
  * In the *Name* field, enter the same name that you used for the deployed application.
  * Select the default value for *Supported account types*.
  * Select *Web* for *Redirect URI (optional)*.
  * In the *Redirect URI (optional)* field, enter the _{MSEntraID} OAuth2 Callback URL_ value that you fetched from {PlatformNameShort}.
. Click *Register* to create the registration.

When registration is complete, the registration page for the {PlatformNameShort} application is displayed.

.Generating secrets for communication

. In the *{PlatformNameShort} application registration page* on Azure, copy and save the value of _Application (client) ID_.
+
You need this value for the _{MSEntraID}OAuth2 Key_ in the {PlatformNameShort} settings.
. Under *Manage*, click *Certificates & secrets*.
. Click *Client secrets* and then *+ New client secret*.
. Provide a description for the new secret.
+
It is not possible to automatically renew a certificate or identify when it is about to expire.
+
It is useful to include the date in the description, for example: _Ansible Automation Platform Client Secret <Today's Date in YYYY-MM-DD format>_.
. Provide an expiration date for the new secret.
+
The maximum lifetime for the certificate is 2 years. Unless you have specific security needs that prevent the creation of a long term certificate, select an expiration date of *24 months*.
. Save the secret _Value_ to a location on your local machine. After you navigate away from this page the secret value is no longer retrievable.

.Creating a service principal for automating Azure resources

[role="_abstract"]
To enable the {PlatformNameShort} application to access and manage Azure resources, you must provide authorization credentials after deployment.
The Microsoft Azure collection supports service principal authentication.

To create a service principal, you must have administrator privileges with tenancy-wide permissions on your Azure tenant.
Your {AAPonAzureNameShort} deployment provisions in the same Subscription ID as the service principal created in this step.

. Navigate to the Azure portal
. Click the link:https://docs.microsoft.com/en-us/azure/cloud-shell/overview[Cloud Shell] icon to open a bash Cloud Shell in your browser.
. Set the Azure CLI to use the subscription that you intend to use for automating Azure services. Run the following command from the shell:
+
-----
az account set --subscription <your_subscription_id>
-----
. Run the following command using the Azure CLI to create a privileged service principal in {MSEntraID}:
+
-----
az ad sp create-for-rbac --name ansible --role Contributor
-----
+
The output displays the _appID_ and _tenant_ keys for the service principal:
+
-----
{
  "appId": "xxxxxxx-xxx-xxxx",
  "displayName": "ansible",
  "name": "xxxxxxx-xxx-xxxx",
  "password": "xxxxxxx-xxx-xxxx",
  "tenant": "xxxxxxx-xxx-xxxx"
}
-----
. Store the service principal details securely, as they are displayed only when you create the secret.


.Maintaining your service principals

Service principal credentials have a limited lifetime that is set in your {MSEntraID} configuration.
Track the lifespan of the service principal if you intend to automate against Azure for an extended period of time.
You can create a new one when needed.

To view records of updated or deleted service principles, run the following Azure CLI command:

-----
az ad sp list -o table | grep ansible
-----

This command does not display the secrets for your service principals. Delete the service principal and create a new one if the secret is lost.

When you create a new service principal to replace an expired or deleted one, you must update the credential that uses the service principal that you are replacing. If the credential is not updated, automations that use that credential will fail.

