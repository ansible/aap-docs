[id="proc-aap-gcp-backup-and-restore"]

= Ansible Automation Platform Backup and Restore Process

To backup and restore your AAP deployment, it is vital to have your existing AAP Admin Secret name and value recorded somewhere safe. In addition, it is also extremely important that regular manual backups of the Cloud SQL DB instance and filestore backups are taken to ensure a deployment can be restored as close as possible to its previous working state. The playbooks backup and restore provides backup and restore support for the AAP on GCP foundation deployment. 

**Note that the restore process deploys a new AAP deployment with the filestore and SQL DB instance being restored to the specified backup.**


The backup process involves taking a backup of the Cloud SQL DB and filestore instances at a given point in time.
The backup playbook require an active {AAPonGCP} foundation deployment to be running.

The following instructions describe how to run the backup playbook.

.Procedure
. Gather the following input variables to create an `extra_vars.yaml` file.
.. *gcp_service_account_credentials_json_path*: Service account crendential json file path for the google cloud account.
.. *gcp_deployment_name*: Deployment name which you want to backup.
.. *gcp_compute_region*: GCP region where foundation deployment deployed.
.. *gcp_compute_zone*: GCP zone where foundation deployment deployed.
+
[source,bash]
----
gcp_deployment_name: "" 
gcp_compute_region: ""
gcp_compute_zone: ""
gcp_service_account_credentials_json_path: "/secret/<service-account-creds-json-filename>"
----
+
. Run the backup playbook. Pull the docker image for operational container having tag with the version of the foundation deployment.
+
[NOTE]
=====  
Operational image tag should match with the version of your foundation deployment. For example, if your foundation deployment version is 2.2.20230215, pull the operational image with tag 2.2.20230215.
=====
+
[source,bash]
----
$ export IMAGE=<image-path>
$ docker pull $IMAGE
----
+
. Running the backup playbook as a container.
+
. Replace `<absolute path to google application credentials dir>` with your path to the service account credential Json file for google cloud and `<absolute path of extra vars dir>` with the path to your directory where you `extra_vars.yaml` file exists which you have created in step 1 of backup process. 
+
. Run the command to run the playbook.
+
[source,bash]
----
$ docker run --rm \
-v <absolute path to google application credentials dir>:/secrets \
-v <absolute path of extra vars dir>:/extra_vars:ro \
quay.io/leena_ibm/ljawale-ansible-on-clouds-ops:latest \
redhat.ansible_on_clouds.gcp_backup_deployment \
-e @/extra_vars/extra_vars.yaml
----
+
Make a note of the SQL DB Backup ID and SQL DB Backup name.
+


=== Resources that are backed up

Once the backup playbook run successfully, the following resources are backup up.
  - CLoud SQL DB instance
  - Filestore instance

== Restore Process

The restore process deploys a new deployment, and restores the filestore and SQL DB instance to the specified backup.

[NOTE]
=====
The restored filestore instance uses CIDR network range `192.168.244.0/29`, which is different from the default network filestore network range of the backup deployment.
=====

Running the restored playbook

The following instructions describe how to run a restore playbook.

. Gather the following input variables to create an `extra_vars.yaml` file.
.. *gcp_service_account_credentials_json_path*: Service account crendential json file path for google cloud account.
.. *gcp_deployment_name*: Deployment name which you backed up.
.. *gcp_restored_deployment_name*: Deployment name of restored AAP foundation created by playbook
.. *gcp_compute_region*: GCP region where foundation deployment deployed.
.. *gcp_compute_zone*: GCP zone where foundation deployment deployed.
.. *gcp_filestore_backup_name*: The backup name where filestore instance backup will be stored (You will get this after executing backup playbook).
.. *gcp_sql_backup_id*: Backup ID of the Cloud SQL DB instance to use when restoring the deployment (You will get this after executing backup playbook).
.. *gcp_sql_backup_db_name*: GCP foundation SQL DB name (You will get this after executing backup playbook).
+
[source,bash]
----
gcp_deployment_name: ""
gcp_restored_deployment_name: ""
gcp_compute_region: ""
gcp_compute_zone: ""
gcp_service_account_credentials_json_path: "/secret/<service-account-creds-json-filename>"
gcp_filestore_backup_name: ""
gcp_sql_backup_id: ""
gcp_sql_backup_db_name: ""
----
+
. Run the restore playbook
+
Pull the docker image for the operational container having tag with the version of the foundation deployment.
+
[NOTE]
=====
The operational image tag should match with the version of your foundation deployment. For example, if your foundation deployment version is 2.2.20230215, pull the operational image with tag 2.2.20230215
=====
+
[source,bash]
----
$ export IMAGE=<image-path>
$ docker pull $IMAGE
----
+
. Running the restore playbook as a container.
+
. Replace `<absolute path to google application credentials dir>` with your path to the service account credential Json file for google cloud and `<absolute path of extra vars dir>` with the path to your directory where you `extra_vars.yaml` file exists which you have created in step 1 of restore process. 
+
. Run the command to run the playbook.
+
[source,bash]
----
$ docker run --rm \
-v <absolute path to google application credentials dir>:/secrets \
-v <absolute path of extra vars dir>:/extra_vars:ro \
quay.io/leena_ibm/ljawale-ansible-on-clouds-ops:latest \
redhat.ansible_on_clouds.gcp_restore_deployment \
-e @/extra_vars/extra_vars.yaml
----
+
. It can take 5-10 minutes for the deployment to finish and for all the containers to run.
+
. You can now successfully log in to {PlatformName} {ControllerName} and {HubName} using your old deployment credentials. In addition, all job history, uploaded collections and other records should be in the same state as the restored deployment.