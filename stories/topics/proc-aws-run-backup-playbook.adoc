[id="proc-aws-run-backup-playbook"]

= Running the backup playbook

The following procedure runs the backup playbook as a container.

.Procedure
. To run the backup, run the command generator.
+
[literal, options="nowrap" subs="+attributes"]
----
$ docker run --rm -v $(pwd)/command_generator_data:/data $IMAGE command_generator aws_backup_stack --data-file /data/extra_vars.yml
----
+
This generates the backup CLI command  
+
[literal, options="nowrap" subs="+attributes"]
----
----------------------------------------------
docker run --rm --env PLATFORM=AWS -v ~/.aws/credentials:/home/runner/.aws/credentials:ro \
--env ANSIBLE_CONFIG=../aws-ansible.cfg --env DEPLOYMENT_NAME=AnsibleAutomationPlatform --env GENERATE_INVENTORY=true  \
$IMAGE redhat.ansible_on_clouds.aws_backup_stack \
-e 'aws_foundation_stack_name=AnsibleAutomationPlatform aws_region=us-east-1 aws_backup_vault_name=Default \
aws_backup_iam_role_arn=arn:aws:iam::<Your AWS Account Number>:role/service-role/AWSBackupDefaultServiceRole \
aws_s3_bucket=ansible-automation-platform-bucket aws_ssm_bucket_name=aap-ssm-bucket backup_prefix=aoc-backup'
===============================================
----
. Run the generated command to trigger the backup.
+
[literal, options="nowrap" subs="+attributes"]
----
$ docker run --rm --env PLATFORM=AWS -v ~/.aws/credentials:/home/runner/.aws/credentials:ro \
--env ANSIBLE_CONFIG=../aws-ansible.cfg --env DEPLOYMENT_NAME=AnsibleAutomationPlatform --env GENERATE_INVENTORY=true  \
$IMAGE redhat.ansible_on_clouds.aws_backup_stack \
-e 'aws_foundation_stack_name=AnsibleAutomationPlatform aws_region=us-east-1 aws_backup_vault_name=Default \
aws_backup_iam_role_arn=arn:aws:iam::<Your AWS Account Number>:role/service-role/AWSBackupDefaultServiceRole \
aws_s3_bucket=ansible-automation-platform-bucket aws_ssm_bucket_name=aap-ssm-bucket backup_prefix=aoc-backup'
----
. The backup can take several minutes to complete, depending on the database size. 
A successful backup returns a log similar to the following:
+
[literal, options="nowrap" subs="+attributes"]
----
{
    "msg": [
        "Successfully backed up AnsibleAutomationPlatform!",
        "Please note below the bucket name, region and backup name which are required for restore process.",
        "aws_s3_bucket: ansible-automation-platform-bucket ",
        "aws_region: us-east-1",
        "aws_backup_name: ansible-automation-platform-bucket-20230706T163309",
        "Your backup files can be found at:",
        "https://s3.console.aws.amazon.com/s3/buckets/ansible-automation-platform-bucket?region=us-east-1&prefix=aoc-backup-AnsibleAutomationPlatform-20230706T163309/&showversions=false"
    ]
}
----
. Your {AAPonAWS} deployment is now successfully backed up. 
As the log shows, the playbook successfully creates a backup folder in the S3 bucket specified above.
