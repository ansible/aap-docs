[id="proc-gcp-application-upgrade"]

= Upgrading your deployment

[IMPORTANT]
====
This is a Techical Preview feature. Technology Preview features are not supported with Red Hat production service-level agreements (SLAs) and might not be functionally complete. Red Hat does not recommend using them for production. These features provide early access to upcoming product features, enabling customers to test functionality and provide feedback during the development process.
====

You can upgrade your existing {AAPonGCP} deployment to the newer version. 
The upgrade process covers upgrading of {HubName} and {ControllerName}. 
The upgrade process takes roughly the same amount of time as a {AAPonGCP} deployment install. 

Use the following procedure to ensure a smooth upgrade process.

[NOTE]
=====
{AAPonGCP} supports sequential upgrades. 
All upgrades should be no more than one major version behind the version you are currently upgrading to. 
For example, to upgrade {AAPonGCP} to 2.2.20230215, you must be on the first version of {AAPonGCP}.
=====

.Prerequisites
* Docker must be installed to run the upgrade playbook.
* The upgrade process requires several volumes to be mounted. 
Prepare a fresh directory to be used for this process.

.Procedure
. Create the directories used to configure the upgrade process using the following commands:
+
[literal, options="nowrap" subs="+quotes,attributes"]
----
# Secrets directory. Store the GCP credentials file.
$ mkdir secrets
# Extra vars directory. All the configuration variables for the upgrade process.
$ mkdir extra_vars
----
+
. Store your service account credential JSON file in the secrets directory. 
+
[NOTE]
=====
To create the GCP credentials file, see, 
link:https://developers.google.com/workspace/guides/create-credentials[Create credentials] and 
link:https://cloud.google.com/iam/docs/keys-create-delete[Create and delete service account keys]
=====
+
. Gather the following input variables to create an `extra_vars.yaml` file within `extra_vars` dir.
* *gcp_service_account_credentials_json_path*:  Service account crendential json file path for the Google cloud account.  This is the path within an `ansible-on-clouds-ops` container where the credentials JSON file is mounted to the `/secrets` directory. The path should be `/secrets/<service-account-creds-json-filename>`. 
+
Replace `<service-account-creds-json-filename>` with your Google service account credential filename.

* *gcp_deployment_name*: Deployment name that you want to upgrade.
* *gcp_compute_region*: GCP region that you provided when deploying foundation deployment. 
If you have not provided a region when deploying the foundation, use the default region `us-east1` here.
* *gcp_compute_zone*: GCP zone that you provided when deploying foundation deployment. 
If you have not provided a zone when deploying the foundation, use the default `us-east1-b` here.
+
[NOTE]
=====
You can find the region and zone from the filestore instance deployed with the foundation deployment. 
Look for the filestore with the name `<deployment-name>-filestore`.

* Make note of the location field that is your `gcp_compute_zone`. 
For example, the filestore instance location might be `us-east1-d`

* Remove the last two characters from the location that is your `gcp_compute_region`. 
For example, if your `gcp_compute_zone` location is `us-east1-d`, your region is `us-east1`.
=====
+
[literal, options="nowrap" subs="+quotes,attributes"]
----
gcp_service_account_credentials_json_path: "/secrets/<service-account-creds-json-filename>"
gcp_deployment_name: "" 
gcp_compute_region: ""
gcp_compute_zone: ""
----
+
. The final result should look similar to the following:
+
[literal, options="nowrap" subs="+quotes,attributes"]
----
$ tree
tree
.
├── extra_vars
│   └── extra_vars.yaml
└── secrets
    └── gc-ansible-cloud-123434.json
----

[discrete]
= Running the upgrade playbook

The following instructions describe how to run the upgrade playbook.

.Procedure
. Pull the docker image for the `ansible-on-clouds-ops` container with a tag the same as the version of the foundation deployment.
+
[NOTE]
=====
The `ansible-on-clouds-ops` container image tag must match the version of your foundation deployment. 
For example, if your foundation deployment version is 2.2.1, pull the `ansible-on-clouds-ops` image with tag 2.2.1.
=====
+
[literal, options="nowrap" subs="+quotes,attributes"]
----
$ export IMAGE=quay.io/ansible-on-clouds/ansible-on-clouds-ops:2.2.1
$ docker pull $IMAGE
----

[discrete]
== Running the upgrade playbook as a container

.Procedure
. Set the `GOOGLE_APPLICATION_CREDENTIALS` variable to the Google cloud credential JSON file path.
+
[literal, options="nowrap" subs="+quotes,attributes"]
----
$ export GOOGLE_APPLICATION_CREDENTIALS=<path to the Google credential JSON file>
----
+
. Replace `<absolute path to secrets dir>` with the path to the service account credential json file for Google cloud.
. Replace `<absolute path of extra vars dir>` with the path to the directory where your `extra_vars.yaml` file exists.
. Replace `<Google-cloud-project-id>` with the project id for your Google account.
. Replace `<deployment-name>` with your foundation deployment name.
. Use the following command to run the playbook.
+
[literal, options="nowrap" subs="+quotes,attributes"]
----
$ docker run --rm \
  --env PLATFORM=GCP \
  --env CLOUDSDK_CORE_PROJECT=<Google-cloud-project-id> \
  --env GOOGLE_APPLICATION_CREDENTIALS=$GOOGLE_APPLICATION_CREDENTIALS \
  --env GENERATE_INVENTORY=true \
  --env DEPLOYMENT_NAME=<deployment-name> \
  -v <absolute path to secrets dir>:/secrets:ro \
  -v <absolute path of extra vars dir>:/extra_vars:ro \
  $IMAGE \
  redhat.ansible_on_clouds.gcp_upgrade \
  -e @/extra_vars/extra_vars.yaml
----
+
. After successfully running the playbook, the playbook returns something similar to the following:
+
[literal, options="nowrap" subs="+quotes,attributes"]
----
TASK [redhat.ansible_on_clouds.standalone_gcp_upgrade : [upgrade] Show GCP current version] ***
ok: [localhost] => {
    "msg": "AAP on GCP upgrade succeeded to version: 2.2.20230215-00"
}
----

. Your {AAPonGCP} deployment is now upgraded to the newer version and you can now successfully log in to {PlatformName} {ControllerName} and {HubName} using your deployment credentials.