[id="ref-aws-additional-configs-secure-controller-load-balancer"]

= Securing the controller load balancer

The following procedure describes how to secure the {ControllerName} load balancer.

.Prereqisites
* Ensure you are using openssl 3 or later

.Procedure
. Generate the {ControllerName} certificate with the following command:
+
[literal, options="nowrap" subs="+attributes"]
----
$ openssl req -x509 -nodes -newkey rsa:4096 -keyout controller_key.pem -out controller_cert.pem -sha256 -days 365 -addext "subjectAltName = DNS:<CONTROLLER_DNS_NAME>"
----
where `CONTROLLER_DNS_NAME` is the DNS name of the controller load balancer. 
Certificates can also be requested or imported into AWS.
. In the {AWS} UI, navigate to menu:ACM[]. 
Ensure you are in the correct region.
. Click btn:[Import] to start the import of the generated certificate.
. Paste the contents of `controller_cert.pem` into the *Certificate body* field.
. Paste the contents of `controller_key.pem` into the *Certificate private key* field.
. Click btn:[Next]
. Optional: Add any additional tags you require. 
. Click btn:[Next].
. Click btn:[Import].

[discrete]
== Updating the {ControllerName} internal load balancer listener

.Procedure
. In the {AWS} UI, navigate to menu:EC2 Load Balancers[]. 
Ensure you are in the correct region.
. Select the internal load balancer for {ControllerName}.
. Click the *Listeners* tab.
. Click btn:[Add listener].
. Select *HTTPS* for the protocol, and ensure the port is `443`.
. Select *Forward* for the default actions, and ensure the target group is `{ControllerName}` instance group.
. Select *Secure listener settings > Default SSL/TLS certificate* and ensure that *From ACM* is selected.
. Select your imported ACM certificate.
. Click btn:[Add].

[discrete]
== Updating the load balancer security group

.Procedure
. In the {AWS} UI, navigate to menu:EC2 Security Groups[]. 
Ensure you are in the correct region.
. Select the {ControllerName} *ALB Security group*.
. Select the *Inbound rules* tab and click btn:[Edit inbound rules].
. Add a rule of Type: `HTTPS`, with Source: `Anywhere-IPv4`.
. Delete the old HTTP rule and click btn:[Save rules].
