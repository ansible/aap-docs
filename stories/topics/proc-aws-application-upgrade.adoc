[id="proc-aap-aws-application-upgrade"]

[IMPORTANT]
====
This is a Techical Preview feature. Technology Preview features are not supported with Red Hat production service-level agreements (SLAs) and might not be functionally complete. Red Hat does not recommend using them for production. These features provide early access to upcoming product features, enabling customers to test functionality and provide feedback during the development process.
====

You can upgrade your existing {AAPonAWS} deployment to the newer version. The upgrade process covers upgrading of {HubName} and {ControllerName}. The upgrade process takes roughly the same time as an {AAPonAWS} deployment install. Follow the steps below to ensure a smooth upgrade process.

[NOTE]
=====
{AAPonAWS} supports sequential upgrades. All upgrades should be no more than one minor version behind what you currently upgrade to. For example, to upgrade to {AAPonAWS} to 2.2.20230215, you must be on the first version of {AAPonAWS}.
=====

.Prerequisites
* Linux or macOS system (where the `ansible-on-clouds-ops` container image will run)
* Docker

.Procedure
. Create the prepare the environment and the configuration files.
. Run the `ansible-on-clouds-ops` container to upgrade your {AAPonAWS} deployment.

= Preparing the environment

The upgrade process requires a few volumes to be mounted. Prepare a directory you can use for this purpose.

Create the directories used to configure the upgrade process.

[literal, options="nowrap" subs="+quotes,attributes"]
----
# Secrets directory. Store the AWS credentials and config files.
$ mkdir secrets

# Extra vars directory. All the configuration variables for the upgrade process.
$ mkdir extra_vars
----

Create the `secrets/config` file and add the following content to it. Remember to replace `us-east-1` with your respective region.

[source,ini]
----
[default]
region = us-east-1
output = json
----

Create the `secrets/credentials` file and add the following content to it. Remember to replace `aws_access_key_id` and `aws_secret_access_key` with your respective credentials.

[NOTE]
=====
To create the AWS credentials,  see link:https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-files.html#cli-configure-files-methods[Configuring the AWS CLI].
=====

[source,ini]
----
[default]
aws_access_key_id=AKIAIOSFODNN7EXAMPLE
aws_secret_access_key=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
----

Create the `extra_vars/extra_vars.yml` file and add the following content to it.

[NOTE]
=====
See the next session for more details on the variables.
=====

[source,yaml]
----
# Main vars
aws_foundation_stack_name: "myDeployment"
aws_region: us-east-1
aws_ssm_bucket_name: "my-s3-bucket-us-east-1"

# Backup vars
aws_backup_vault_name: Default
aws_backup_iam_role_arn: arn:aws:iam::<YOUR_ACCOUNT_NUMBER>:role/service-role/AWSBackupDefaultServiceRole
----

= Setting up the extra_vars/extra_vars.yaml configuration file

. Main variables.
** *aws_foundation_stack_name*: The name of the foundation deployment. This is the same name you used when you deployed the foundation.
** *aws_region*: The region where the foundation deployment is located.
** *aws_ssm_bucket_name*: The name of the S3 bucket where the configuration files for the AWS SSM are stored. Can be an existent bucket used of AWS SSM or a new one
. The AWS Backup. The upgrade process will create a backup of your existing deployment before the main process starts. It requires the following variables:
** *aws_backup_vault_name*: The name of the AWS Backup vault to use. The vault must exist in the same region as the deployment.
** *aws_backup_iam_role_arn*: The ARN of the IAM role to use for the backup. The role must have the `AWSBackupServiceRolePolicyForBackup` policy attached to it. If you want to use the default AWS Backup service role, use the following ARN: `arn:aws:iam::<YOUR_ACCOUNT_NUMBER>:role/service-role/AWSBackupDefaultServiceRole`.

The final result should look like this:

[literal, options="nowrap" subs="+quotes,attributes"]
----
$ tree
.
├── extra_vars/
│   └── extra_vars.yml
└── secrets/
    ├── config
    └── credentials
----

= Performing the upgrade

The following instructions describe how to run the upgrade playbook.

.Procedure

. Pull the Docker image for Ansible on Clouds operational container having tag with the version which you want to upgrade to.

[NOTE]
=====
The Ansible on Clouds operational image tag must match with the version which you want to upgrade to. For example, if your foundation deployment version is 2.2.0, pull operational image with tag 2.2.20230215 to upgrade to version 2.2.20230215.
=====

[literal, options="nowrap" subs="+quotes,attributes"]
----
$ export IMAGE=<image-path>
$ docker pull $IMAGE
----

= Running

.Procedure

. Replace `<deployment-name>` with your foundation deployment name. Use the following command to run the playbook.

[literal, options="nowrap" subs="+quotes,attributes"]
----
# Export the volume paths
$ export VOLUME_AWS_CREDENTIALS_DIR=<absolute path to workdir>/secrets
$ export VOLUME_EXTRA_VARS_DIR=<absolute path to workdir>/extra_vars

$ docker run --rm \
    --env PLATFORM=AWS \
    --env DEPLOYMENT_NAME=<deployment-name> \
    --env GENERATE_INVENTORY=true \
    -v ${VOLUME_AWS_CREDENTIALS_DIR}:/home/runner/.aws/:rw \
    -v ${VOLUME_EXTRA_VARS_DIR}:/extra_vars:ro \
    ${IMAGE} \
      redhat.ansible_on_clouds.aws_upgrade \
      -e @/extra_vars/extra_vars.yml
----

. After successfully running the playbook, the playbook will return something like this

[literal, options="nowrap" subs="+quotes,attributes"]
----
TASK [redhat.ansible_on_clouds.standalone_aws_upgrade : [upgrade] [LOG] upgrade version] ***
ok: [localhost] => {
    "msg": "Successfully upgraded from '2.2.20221201-00' -> '2.2.20230215-00'."
}
----

Your {AAPonAWS} deployment is now upgraded to a newer version and you can log in to {PlatformName} {ControllerName} and {HubName} using your deployment credentials.
