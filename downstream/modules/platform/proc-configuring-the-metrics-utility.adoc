:_newdoc-version: 2.18.3
:_template-generated: 2024-07-15
:_mod-docs-content-type: PROCEDURE

[id="configuring-the-metrics-utility"]
= Configuring metrics-utility

Configure the `metrics-utility` to gather and report usage data for your {PlatformNameShort}, both on {RHEL} and {OCPShort}.

== Configuring metrics-utility on {RHEL} 

.Prerequisites:

* **Subscription:** An active {PlatformNameShort} subscription.
* **Installation:** The `metrics-utility` tool is included by default with the {PlatformNameShort} installation on the {ControllerName} node. No separate installation is required.
* **User privileges:** You must be logged in as the `root` user or the `awx` user to run the `metrics-utility` tool.

[IMPORTANT]
====
The `metrics-utility` requires read access to `/etc/tower/SECRET_KEY` to function correctly.
Attempting to run this utility as a standard user (non-root or non-awx) results in a `PermissionError` and execution failure.
====

The following commands gather the relevant data and generate a link:https://connect.redhat.com/en/programs/certified-cloud-service-provider[CCSP] report containing your usage metrics. 
You can configure these commands as `cron` jobs to ensure they run at the beginning of every month. 
See link:https://www.redhat.com/sysadmin/linux-cron-command[How to schedule jobs using the Linux `cron` utility] for more on configuring using the cron syntax. 

.Procedure

. Create two scripts in your user's home directory to set correct variables to ensure that `metrics-utility` gathers all relevant data:
.. In `/home/my-user/cron-gather`:
+
[source, ]
----
#!/bin/sh

# Specify the following variables to indicate where the report is deposited in your file system:
export METRICS_UTILITY_SHIP_TARGET=directory
export METRICS_UTILITY_SHIP_PATH=/awx_devel/awx-dev/metrics-utility/shipped_data/billing

# Run the following command to gather and store the data in the provided SHIP_PATH directory:
metrics-utility gather_automation_controller_billing_data --ship --until=10m
----
+
.. In `/home/my-user/cron-report`:
+
[source, ]
----
#!/bin/sh

# Specify the following variables to indicate where the report is deposited in your file system:
export METRICS_UTILITY_SHIP_TARGET=directory
export METRICS_UTILITY_SHIP_PATH=/awx_devel/awx-dev/metrics-utility/shipped_data/billing

# Set these variables to generate a report:
export METRICS_UTILITY_REPORT_TYPE=CCSPv2
export METRICS_UTILITY_PRICE_PER_NODE=11.55 # in USD
export METRICS_UTILITY_REPORT_SKU=MCT3752MO
export METRICS_UTILITY_REPORT_SKU_DESCRIPTION="EX: Red Hat Ansible Automation Platform, Full Support (1 Managed Node, Dedicated, Monthly)"
@@ -44,21 +51,31 @@ export METRICS_UTILITY_REPORT_EMAIL="email@email.com"
export METRICS_UTILITY_REPORT_RHN_LOGIN="test_login"
export METRICS_UTILITY_REPORT_COMPANY_BUSINESS_LEADER="BUSINESS LEADER"
export METRICS_UTILITY_REPORT_COMPANY_PROCUREMENT_LEADER="PROCUREMENT LEADER"

# Build the report
metrics-utility build_report
----
+
. To ensure that these files are executable, run: 
+
[source, ]
----
chmod a+x /home/my-user/cron-gather /home/my-user/cron-report
----
+
. To open the `cron` file for editing, run:
+
[source, ]
----
crontab -e
----
+
. To configure the run schedule, add the following parameters to the end of the file and specify how often you want `metrics-utility` to gather information and build a report using the link:https://www.redhat.com/sysadmin/linux-cron-command[cron syntax]. In the following example, the `gather` command is configured to run every hour at 00 minutes. The `build_report` command is configured to run on the second day of each month at 4:00 AM. 
+
[source, ]
----
0 */1 * * * /home/my-user/cron-gather
0 4 2 * * /home/my-user/cron-report
----
+
. Save and close the file.
. To verify that you saved your changes, run:
+
[source, ]
----
crontab -l
----
+
. To ensure that data is being collected, run: 
+
[source, ]
----
cat /var/log/cron 
----
+
The following is an example of the output. Note that time and date might vary depending on how your configure the run schedule:
+
[source, ]
----
May  8 09:45:03 ip-10-0-6-23 CROND[51623]: (root) CMDOUT (No billing data for month: 2024-04)
May  8 09:45:03 ip-10-0-6-23 CROND[51623]: (root) CMDEND (metrics-utility build_report)
May  8 09:45:19 ip-10-0-6-23 crontab[51619]: (root) END EDIT (root)
May  8 09:45:34 ip-10-0-6-23 crontab[51659]: (root) BEGIN EDIT (root)
May  8 09:46:01 ip-10-0-6-23 CROND[51688]: (root) CMD (metrics-utility gather_automation_controller_billing_data --ship --until=10m)
May  8 09:46:03 ip-10-0-6-23 CROND[51669]: (root) CMDOUT (/tmp/9e3f86ee-c92e-4b05-8217-72c496e6ffd9-2024-05-08-093402+0000-2024-05-08-093602+0000-0.tar.gz)
May  8 09:46:03 ip-10-0-6-23 CROND[51669]: (root) CMDEND (metrics-utility gather_automation_controller_billing_data --ship --until=10m)
May  8 09:46:26 ip-10-0-6-23 crontab[51659]: (root) END EDIT (root)
----
+

The generated report will have the default name CCSP-<YEAR>-<MONTH>.xlsx and will be deposited in the ship path that you specified in step 1a.

== Configuring metrics-utility on {OCPShort} from the {PlatformNameShort} operator

`metrics-utility` is included in the {OCPShort} {ControllerName} image for versions 4.12, 4.5.12, and 4.6. If your system does not have `metrics-utility` installed, update your OpenShift image to the latest version. 

Create a *ConfigMap* in the OpenShift UI YAML view and deploy automation controller to configure the run schedule for `metrics-utility` on {OCPShort} using the {PlatformNameShort} operator.

.Prerequisites:
* A running OpenShift cluster
* An operator-based installation of {PlatformNameShort} on {OCPShort}. 

NOTE:  `metrics-utility` will run as indicated by the parameters you set in the configuration file. 

=== Create a ConfigMap in the OpenShift UI YAML view

To inject the `metrics-utility` cronjobs with configuration data, use the following procedure to create a ConfigMap in the OpenShift UI YAML view:

. From the navigation panel on the left side, select *ConfigMaps*, and then click the *Create ConfigMap* button.
. On the next screen, select the *YAML view* tab.
. In the `YAML` field, enter the following parameters with the appropriate variables set: 
+
[source, ]
----
apiVersion: v1
kind: ConfigMap
metadata:
  name: automationcontroller-metrics-utility-configmap
data:
  METRICS_UTILITY_SHIP_TARGET: directory
  METRICS_UTILITY_SHIP_PATH: /metrics-utility
  METRICS_UTILITY_REPORT_TYPE: CCSP
  METRICS_UTILITY_PRICE_PER_NODE: '11' # in USD
  METRICS_UTILITY_REPORT_SKU: MCT3752MO
  METRICS_UTILITY_REPORT_SKU_DESCRIPTION: "EX: Red Hat Ansible Automation Platform, Full Support (1 Managed Node, Dedicated, Monthly)"
  METRICS_UTILITY_REPORT_H1_HEADING: "CCSP Reporting <Company>: ANSIBLE Consumption"
  METRICS_UTILITY_REPORT_COMPANY_NAME: "Company Name"
  METRICS_UTILITY_REPORT_EMAIL: "email@email.com"
  METRICS_UTILITY_REPORT_RHN_LOGIN: "test_login"
  METRICS_UTILITY_REPORT_COMPANY_BUSINESS_LEADER: "BUSINESS LEADER"
  METRICS_UTILITY_REPORT_COMPANY_PROCUREMENT_LEADER: "PROCUREMENT LEADER"
----
+
. Click btn:[Create].
. To verify that the ConfigMap was created and the metric utility is installed, select *ConfigMap* from the navigation panel and look for your ConfigMap in the list.


=== Deploy {ControllerName}

To deploy {ControllerName} and specify variables for how often `metrics-utility` gathers usage information and generates a report, use the following procedure: 

.Procedure

. From the navigation panel, select *Installed Operators*.
. Select {PlatformNameShort}.
. In the Operator details, select the *{ControllerName}* tab.
. Click btn:[Create {ControllerName}]*.
. Select the *YAML view* option. The `YAML` now shows the default parameters for {ControllerName}. 
The relevant parameters for `metrics-utility` are the following: 
+
----
[cols="50%,50%",options="header"]
|====
| *Parameter* | *Variable*
| *`metrics_utility_enabled`* | True.
| *`metrics_utility_cronjob_gather_schedule`* | @hourly or @daily.
| *`metrics_utility_cronjob_report_schedule`* | @daily or @monthly.
|====
----
+
. Find the `metrics_utility_enabled` parameter and change the variable to `true`.
. Find the `metrics_utility_cronjob_gather_schedule` parameter and enter a variable for how often the utility should gather usage information (for example, @hourly or @daily). 
. Find the `metrics_utility_cronjob_report_schedule` parameter and enter a variable for how often the utility generates a report (for example, @daily or @monthly).
. Click btn:[Create].